---
- name: Generate SSL certificate with Certbot
  ansible.builtin.shell:
    cmd: certbot certonly --standalone -d {{ publid_domain }} --non-interactive --agree-tos -m {{ author_email }}
  args:
    warn: false
  register: certbot_output
  changed_when: "'Congratulations' in certbot_output.stdout"
  delegate_to: "{{ item }}"
  run_once: true
  loop: "{{ groups['boundary_controller'][0] }}"

- name: Fetch certificate from the node
  ansible.builtin.fetch:
    src: "/etc/letsencrypt/live/{{ public_domain }}/fullchain.pem"
    dest: "./certs/{{ inventory_hostname }}/boundary-cert.pem"
    flat: yes
  delegate_to: "{{ groups['boundary_controller'][0] }}"
  run_once: true

- name: Fetch private key from the node
  ansible.builtin.fetch:
    src: "/etc/letsencrypt/live/{{ public_domain }}/privkey.pem"
    dest: "./certs/{{ inventory_hostname }}/boundary-key.pem"
    flat: yes
  delegate_to: "{{ groups['boundary_controller'][0] }}"
  run_once: true

- name: Ensure the destination directory exists on all controller nodes
  ansible.builtin.file:
    path: /etc/boundary.d/tls
    state: directory
    mode: '0755'
  loop: "{{ groups['boundary_controller'] }}"

- name: Distribute certificate to all controller nodes
  ansible.builtin.copy:
    src: "./certs/{{ inventory_hostname }}/boundary-cert.pem"
    dest: "{{ tls_dir }}/boundary-cert.pem"
    mode: '0644'
  loop: "{{ groups['boundary_controller'] }}"

- name: Distribute private key to all controller nodes
  ansible.builtin.copy:
    src: "./certs/{{ inventory_hostname }}/boundary-key.pem"
    dest: "{{ tls_dir }}/boundary-key.pem"
    mode: '0600'
  loop: "{{ groups['boundary_controller'] }}"